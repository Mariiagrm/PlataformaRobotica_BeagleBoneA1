<!DOCTYPE html>
<html>
<head>
    <title> Robot Maria y Okeolesandra </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>    
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #f7e5e5; color: rgb(90, 2, 64); touch-action: manipulation; }
        .container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; max-width: 300px; margin: 50px auto; }
        button { padding: 30px; font-size: 30px; border-radius: 10px; border: none; background: #dac0c0; color: white; touch-action: manipulation; }
        button:active { background: #df7edf; }
        .hidden { visibility: hidden; }
        #status { margin-top: 20px; color: lime; }
        
        /* Estilo para la caja del sensor */
        .sensor-box {
            background-color: #fff;
            padding: 10px;
            border-radius: 10px;
            margin: 10px auto;
            width: 200px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <h1>Robot Maria y Okeolesandra</h1>

    <div class="sensor-box">
        <h3>Distancia</h3>
        <p style="font-size: 24px; font-weight: bold;">
            <span id="distVal">--</span> cm
        </p>
    </div>
    <h3 id="status">Conectando...</h3>
    
    <input type="range" min="0" max="100" value="50" id="speedSlider" onchange="sendSpeed(this.value)">   
    <p>Velocidad: <span id="speedVal">50</span>%</p>

    <div class="container">
        <button class="hidden"></button>
        <button ontouchstart="sendCommand('adelante')" onmousedown="sendCommand('adelante')" 
                ontouchend="sendCommand('stop')" onmouseup="sendCommand('stop')">⬆️</button>
        <button class="hidden"></button>

        <button ontouchstart="sendCommand('izquierda')" onmousedown="sendCommand('izquierda')" 
                ontouchend="sendCommand('stop')" onmouseup="sendCommand('stop')">⬅️</button>
        <button ontouchstart="sendCommand('stop')" onmousedown="sendCommand('stop')" style="background:#cc0000;">⏹️</button>
        <button ontouchstart="sendCommand('derecha')" onmousedown="sendCommand('derecha')" 
                ontouchend="sendCommand('stop')" onmouseup="sendCommand('stop')">➡️</button>

        <button class="hidden"></button>
        <button ontouchstart="sendCommand('atras')" onmousedown="sendCommand('atras')" 
                ontouchend="sendCommand('stop')" onmouseup="sendCommand('stop')">⬇️</button>
        <button class="hidden"></button>
    </div>

    <button onclick="toggleMode()">Cambiar Modo (Manual/Auto)</button>

    <script>
        var socket = io({
            transports: ['websocket', 'polling']
        });

        var currentSpeed = document.getElementById("speedSlider").value;

        socket.on('connect', function() {
            document.getElementById("status").innerText = "Conectado ✅";
            document.getElementById("status").style.color = "lime";
        });

        socket.on('disconnect', function() {
            document.getElementById("status").innerText = "Desconectado ⚠️";
            document.getElementById("status").style.color = "orange";
        });

        socket.on('connect_error', function(error) {
            document.getElementById("status").innerText = "Error conexión ❌";
            document.getElementById("status").style.color = "red";
            console.error('Socket Error:', error);
        });

        // ACTUALIZACIÓN DEL VALOR DEL SENSOR
        socket.on('sensor_update', function(msg) {
            var distancia = parseFloat(msg.distancia).toFixed(1); 
            
            var display = document.getElementById("distVal");
            if(display) {
                display.innerText = distancia;
                
                // Cambio de color visual si está muy cerca (< 20cm)
                if (distancia < 20 && distancia > 0) {
                    display.style.color = "red";
                } else {
                    display.style.color = "black";
                }
            }
        });

        function sendCommand(cmd) {
            var currentVal = document.getElementById("speedSlider").value;
            var mensaje = cmd + " " + currentVal;
            console.log("Enviando: " + mensaje);
            socket.emit('comando', {data: mensaje});
        }

        function sendSpeed(val) {
            document.getElementById("speedVal").innerText = val;
        }
        
        function toggleMode() {
            socket.emit('modo_switch');
        }
    </script>
</body>
</html>